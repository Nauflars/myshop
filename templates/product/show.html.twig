{% extends 'base.html.twig' %}

{% block title %}Product Details{% endblock %}

{% block body %}
<div class="container">
    <div class="row my-4">
        <div class="col-12">
            <a href="/products" class="btn btn-outline-secondary mb-3">‚Üê Back to Products</a>
        </div>
    </div>
    
    <div id="product-details">
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productId = window.location.pathname.split('/').pop();
    const productDetails = document.getElementById('product-details');
    const cartManager = window.cartManager || new CartManager();
    
    fetch(`/api/products/${productId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Product not found');
            }
            return response.json();
        })
        .then(product => {
            productDetails.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body d-flex align-items-center justify-content-center" style="min-height: 400px; background-color: #f8f9fa;">
                                <i class="bi bi-box-seam" style="font-size: 8rem; color: #dee2e6;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h1>${escapeHtml(product.name)}</h1>
                        <p class="text-muted lead">${escapeHtml(product.category)}</p>
                        <hr>
                        <div class="mb-4">
                            <h3 class="text-primary">${(product.priceInCents / 100).toFixed(2)} ${product.currency}</h3>
                        </div>
                        <div class="mb-4">
                            <h5>Description</h5>
                            <p>${escapeHtml(product.description)}</p>
                        </div>
                        <div class="mb-4">
                            <h5>Availability</h5>
                            <p>
                                ${product.stock > 0 ? 
                                    `<span class="badge bg-success">In Stock (${product.stock} available)</span>` : 
                                    '<span class="badge bg-danger">Out of Stock</span>'}
                                ${product.stock > 0 && product.stock < 10 ? '<span class="badge bg-warning ms-2">Low Stock</span>' : ''}
                            </p>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-lg" id="add-to-cart-btn" 
                                    data-product-id="${product.id}"
                                    ${product.stock === 0 ? 'disabled' : ''}>
                                ${product.stock === 0 ? 'Out of Stock' : 'Add to Cart'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            if (addToCartBtn && product.stock > 0) {
                addToCartBtn.addEventListener('click', () => {
                    cartManager.addToCart(product.id);
                });
            }
        })
        .catch(error => {
            console.error('Error loading product:', error);
            productDetails.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading">Product Not Found</h4>
                    <p>The product you're looking for doesn't exist or has been removed.</p>
                    <hr>
                    <a href="/products" class="btn btn-primary">Browse Products</a>
                </div>
            `;
        });
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
});
</script>
{% endblock %}
