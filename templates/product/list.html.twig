{% extends 'base.html.twig' %}

{% block title %}Products{% endblock %}

{% block body %}
<div class="container">
    <h1 class="my-4">Products</h1>
    
    <!-- Search and Filter Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="search-form" class="row g-3">
                <div class="col-md-4">
                    <label for="search-query" class="form-label">Search</label>
                    <input type="text" class="form-control" id="search-query" name="q" placeholder="Search products...">
                </div>
                <div class="col-md-3">
                    <label for="category" class="form-label">Category</label>
                    <select class="form-select" id="category" name="category">
                        <option value="">All Categories</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Books">Books</option>
                        <option value="Home">Home</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="min-price" class="form-label">Min Price</label>
                    <input type="number" class="form-control" id="min-price" name="minPrice" placeholder="0">
                </div>
                <div class="col-md-2">
                    <label for="max-price" class="form-label">Max Price</label>
                    <input type="number" class="form-control" id="max-price" name="maxPrice" placeholder="1000">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Filter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Products Grid -->
    <div id="products-container" class="row">
        <div class="col-12 text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <nav id="pagination-nav" class="mt-4 d-none">
        <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('search-form');
    const productsContainer = document.getElementById('products-container');
    const cartManager = window.cartManager || new CartManager();
    
    function loadProducts() {
        const formData = new FormData(searchForm);
        const params = new URLSearchParams(formData);
        
        productsContainer.innerHTML = '<div class="col-12 text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        
        fetch(`/api/products?${params.toString()}`)
            .then(response => response.json())
            .then(products => {
                if (products.length === 0) {
                    productsContainer.innerHTML = '<div class="col-12"><p class="text-center text-muted">No products found.</p></div>';
                    return;
                }
                
                productsContainer.innerHTML = products.map(product => `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">${escapeHtml(product.name)}</h5>
                                <p class="card-text text-muted">${escapeHtml(product.category)}</p>
                                <p class="card-text">${escapeHtml(product.description)}</p>
                                <p class="card-text">
                                    <strong>Price:</strong> ${product.price.currency} ${(product.price.amount / 100).toFixed(2)}<br>
                                    <strong>Stock:</strong> ${product.stock}${product.stock < 10 ? ' <span class="badge bg-warning">Low Stock</span>' : ''}
                                </p>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-primary btn-sm add-to-cart-btn w-100" 
                                        data-product-id="${product.id}"
                                        ${product.stock === 0 ? 'disabled' : ''}>
                                    ${product.stock === 0 ? 'Out of Stock' : 'Add to Cart'}
                                </button>
                                <a href="/products/${product.id}" class="btn btn-outline-secondary btn-sm w-100 mt-2">View Details</a>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Attach event listeners to add to cart buttons
                document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        cartManager.addToCart(btn.dataset.productId);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading products:', error);
                productsContainer.innerHTML = '<div class="col-12"><p class="text-center text-danger">Error loading products. Please try again.</p></div>';
            });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        loadProducts();
    });
    
    // Load products on page load
    loadProducts();
});
</script>
{% endblock %}
