{% extends 'base.html.twig' %}

{% block title %}Products{% endblock %}

{% block body %}
<div class="container">
    <h1 class="my-4">Products</h1>
    
    <!-- Search and Filter Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="search-form" class="row g-3">
                <div class="col-md-4">
                    <label for="search-query" class="form-label">Search</label>
                    <input type="text" class="form-control" id="search-query" name="q" placeholder="e.g., laptop for gaming, comfortable shoes...">
                </div>
                <div class="col-md-2">
                    <label for="search-mode" class="form-label">Search Mode</label>
                    <select class="form-select" id="search-mode" name="mode">
                        <option value="semantic" selected>ðŸ§  Smart Search</option>
                        <option value="keyword">ðŸ”¤ Exact Words</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="category" class="form-label">Category</label>
                    <select class="form-select" id="category" name="category">
                        <option value="">All Categories</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Books">Books</option>
                        <option value="Home">Home</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="limit" class="form-label">Results</label>
                    <select class="form-select" id="limit" name="limit">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Search</button>
                </div>
            </form>
            <small class="text-muted mt-2 d-block">
                <strong>Smart Search:</strong> Understands meaning (e.g., "laptop for gaming" finds gaming computers)
                <br>
                <strong>Exact Words:</strong> Searches for exact keywords
            </small>
        </div>
    </div>

    <!-- Products Grid -->
    <div id="products-container" class="row">
        <div class="col-12 text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <nav id="pagination-nav" class="mt-4 d-none">
        <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('search-form');
    const productsContainer = document.getElementById('products-container');
    const cartManager = window.cartManager || new CartManager();
    
    function loadProducts() {
        const formData = new FormData(searchForm);
        const params = new URLSearchParams(formData);
        const query = params.get('q');
        const mode = params.get('mode') || 'semantic';
        
        productsContainer.innerHTML = '<div class="col-12 text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        
        // Use semantic search endpoint if query is provided, otherwise list all products
        const endpoint = query && query.trim() 
            ? `/api/products/search?${params.toString()}` 
            : `/api/products?category=${params.get('category') || ''}&limit=${params.get('limit') || 20}`;
        
        fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                // Handle both search results (SearchResult object) and direct product list
                const products = data.products || data;
                const searchInfo = data.metadata || null;
                
                if (products.length === 0) {
                    productsContainer.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <h5>No products found</h5>
                                <p class="mb-0">Try adjusting your search criteria or using <strong>Smart Search</strong> mode</p>
                            </div>
                        </div>`;
                    return;
                }
                
                // Show search metadata if available
                let searchMetaHtml = '';
                if (searchInfo) {
                    const modeLabel = searchInfo.mode === 'semantic' ? 'ðŸ§  Smart Search' : 'ðŸ”¤ Exact Words';
                    searchMetaHtml = `
                        <div class="col-12 mb-3">
                            <div class="alert alert-success">
                                ${modeLabel}: Found <strong>${searchInfo.total_results}</strong> products in ${searchInfo.execution_time_ms}ms
                                ${searchInfo.cache_hit ? ' <span class="badge bg-info">Cached</span>' : ''}
                            </div>
                        </div>`;
                }
                
                productsContainer.innerHTML = searchMetaHtml + products.map(product => `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">${escapeHtml(product.name)}</h5>
                                <p class="card-text text-muted">${escapeHtml(product.category)}</p>
                                <p class="card-text small">${escapeHtml(product.description.substring(0, 100))}${product.description.length > 100 ? '...' : ''}</p>
                                <p class="card-text">
                                    <strong>Price:</strong> ${product.price.currency} ${(product.price.amount / 100).toFixed(2)}<br>
                                    <strong>Stock:</strong> ${product.stock}${product.stock < 10 && product.stock > 0 ? ' <span class="badge bg-warning">Low Stock</span>' : ''}
                                    ${product.similarity_score ? `<br><strong>Match:</strong> <span class="badge bg-success">${(product.similarity_score * 100).toFixed(0)}%</span>` : ''}
                                </p>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-primary btn-sm add-to-cart-btn w-100" 
                                        data-product-id="${product.id}"
                                        ${product.stock === 0 ? 'disabled' : ''}>
                                    ${product.stock === 0 ? 'Out of Stock' : 'Add to Cart'}
                                </button>
                                <a href="/products/${product.id}" class="btn btn-outline-secondary btn-sm w-100 mt-2">View Details</a>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Attach event listeners to add to cart buttons
                document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        cartManager.addToCart(btn.dataset.productId);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading products:', error);
                productsContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger text-center">
                            <h5>Error loading products</h5>
                            <p class="mb-0">Please try again. If using Smart Search and no results appear, try <strong>Exact Words</strong> mode.</p>
                        </div>
                    </div>`;
            });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        loadProducts();
    });
    
    // Load products on page load (without search query, just list all)
    loadProducts();
});
</script>
{% endblock %}
