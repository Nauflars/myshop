openapi: 3.0.3
info:
  title: MyShop Deployment Health Check API
  description: |
    Health check endpoints used by the CI/CD pipeline to verify successful deployments.
    These endpoints provide quick verification that the application and its dependencies
    (database, cache, message queue) are operational after deployment.
  version: 1.0.0
  contact:
    name: MyShop DevOps Team
    email: devops@myshop.com

servers:
  - url: https://myshop.com
    description: Production environment
  - url: https://test.myshop.com
    description: Test/Staging environment
  - url: http://localhost
    description: Local development

tags:
  - name: Health
    description: Health check endpoints for deployment verification

paths:
  /health:
    get:
      tags:
        - Health
      summary: Overall application health check
      description: |
        Returns overall application health status. This is the primary endpoint
        used by Ansible post-deployment verification and load balancer health checks.
        
        Returns 200 OK if application is healthy, 503 Service Unavailable otherwise.
      operationId: getHealth
      responses:
        '200':
          description: Application is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "ok"
                environment: "production"
                version: "v1.2.3"
                timestamp: "2026-02-13T15:00:00Z"
                checks:
                  database: "ok"
                  redis: "ok"
                  mongodb: "ok"
                  rabbitmq: "ok"
        '503':
          description: Application is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "error"
                environment: "production"
                version: "v1.2.3"
                timestamp: "2026-02-13T15:00:00Z"
                checks:
                  database: "ok"
                  redis: "error"
                  mongodb: "ok"
                  rabbitmq: "ok"
                errors:
                  - service: "redis"
                    message: "Connection refused to redis:6379"

  /api/health/database:
    get:
      tags:
        - Health
      summary: Database health check
      description: |
        Verifies MySQL database connectivity and query execution.
        Tests both read and write capabilities.
      operationId: getDatabaseHealth
      responses:
        '200':
          description: Database is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceHealthResponse'
              example:
                service: "database"
                status: "ok"
                response_time_ms: 12
                details:
                  type: "mysql"
                  version: "8.0.35"
                  host: "localhost"
                  database: "myshop_production"
        '503':
          description: Database is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceHealthResponse'
              example:
                service: "database"
                status: "error"
                response_time_ms: null
                error: "SQLSTATE[HY000] [2002] Connection refused"

  /api/health/redis:
    get:
      tags:
        - Health
      summary: Redis cache health check
      description: |
        Verifies Redis connectivity and caching operations.
        Tests SET and GET operations.
      operationId: getRedisHealth
      responses:
        '200':
          description: Redis is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceHealthResponse'
              example:
                service: "redis"
                status: "ok"
                response_time_ms: 3
                details:
                  host: "localhost"
                  port: 6379
                  used_memory: "1.5M"
        '503':
          description: Redis is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceHealthResponse'
              example:
                service: "redis"
                status: "error"
                response_time_ms: null
                error: "Connection refused to localhost:6379"

  /api/health/mongodb:
    get:
      tags:
        - Health
      summary: MongoDB health check
      description: |
        Verifies MongoDB connectivity for embeddings and search operations.
        Tests connection to the specified database.
      operationId: getMongoDBHealth
      responses:
        '200':
          description: MongoDB is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceHealthResponse'
              example:
                service: "mongodb"
                status: "ok"
                response_time_ms: 8
                details:
                  host: "localhost"
                  port: 27017
                  database: "myshop_production"
                  version: "7.0.5"
        '503':
          description: MongoDB is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceHealthResponse'
              example:
                service: "mongodb"
                status: "error"
                response_time_ms: null
                error: "No suitable servers found"

  /api/health/rabbitmq:
    get:
      tags:
        - Health
      summary: RabbitMQ message queue health check
      description: |
        Verifies RabbitMQ connectivity for asynchronous message processing.
        Tests connection to the message broker.
      operationId: getRabbitMQHealth
      responses:
        '200':
          description: RabbitMQ is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceHealthResponse'
              example:
                service: "rabbitmq"
                status: "ok"
                response_time_ms: 5
                details:
                  host: "localhost"
                  port: 5672
                  vhost: "/"
                  queues_count: 3
        '503':
          description: RabbitMQ is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceHealthResponse'
              example:
                service: "rabbitmq"
                status: "error"
                response_time_ms: null
                error: "Connection timeout to localhost:5672"

  /api/health/disk:
    get:
      tags:
        - Health
      summary: Disk space health check
      description: |
        Verifies available disk space on critical mount points.
        Warns if disk usage exceeds 80%, critical if exceeds 90%.
      operationId: getDiskHealth
      responses:
        '200':
          description: Disk space is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceHealthResponse'
              example:
                service: "disk"
                status: "ok"
                response_time_ms: 1
                details:
                  mount_points:
                    - path: "/"
                      total_gb: 100
                      used_gb: 45
                      available_gb: 55
                      usage_percent: 45
                    - path: "/var/www/myshop"
                      total_gb: 500
                      used_gb: 120
                      available_gb: 380
                      usage_percent: 24
        '503':
          description: Disk space is critical
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceHealthResponse'
              example:
                service: "disk"
                status: "error"
                response_time_ms: 1
                error: "Disk usage critical on /"
                details:
                  mount_points:
                    - path: "/"
                      total_gb: 100
                      used_gb: 95
                      available_gb: 5
                      usage_percent: 95

  /api/health/detailed:
    get:
      tags:
        - Health
      summary: Detailed health check with metrics
      description: |
        Returns comprehensive health information including all service checks,
        application metrics, and system information. Used for dashboard monitoring.
      operationId: getDetailedHealth
      responses:
        '200':
          description: Detailed health information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DetailedHealthResponse'
              example:
                status: "ok"
                environment: "production"
                version: "v1.2.3"
                commit: "7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6"
                deployed_at: "2026-02-13T15:00:00Z"
                uptime_seconds: 3600
                timestamp: "2026-02-13T16:00:00Z"
                services:
                  database:
                    status: "ok"
                    response_time_ms: 12
                    details:
                      type: "mysql"
                      version: "8.0.35"
                      active_connections: 5
                  redis:
                    status: "ok"
                    response_time_ms: 3
                    details:
                      used_memory: "1.5M"
                      connected_clients: 2
                  mongodb:
                    status: "ok"
                    response_time_ms: 8
                    details:
                      version: "7.0.5"
                  rabbitmq:
                    status: "ok"
                    response_time_ms: 5
                    details:
                      queues_count: 3
                      pending_messages: 12
                  disk:
                    status: "ok"
                    response_time_ms: 1
                    details:
                      usage_percent: 45
                metrics:
                  php_version: "8.3.2"
                  php_memory_usage_mb: 128
                  php_memory_peak_mb: 145
                  opcache_enabled: true
                  opcache_hit_rate: 98.5

components:
  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - environment
        - timestamp
      properties:
        status:
          type: string
          enum: [ok, error]
          description: Overall health status
        environment:
          type: string
          enum: [development, test, production]
          description: Application environment
        version:
          type: string
          description: Application version (semantic version or commit SHA)
          example: "v1.2.3"
        timestamp:
          type: string
          format: date-time
          description: Health check timestamp (ISO 8601)
        checks:
          type: object
          description: Individual service health statuses
          properties:
            database:
              type: string
              enum: [ok, error]
            redis:
              type: string
              enum: [ok, error]
            mongodb:
              type: string
              enum: [ok, error]
            rabbitmq:
              type: string
              enum: [ok, error]
        errors:
          type: array
          description: List of errors if status is 'error'
          items:
            type: object
            properties:
              service:
                type: string
                description: Name of the failing service
              message:
                type: string
                description: Error message

    ServiceHealthResponse:
      type: object
      required:
        - service
        - status
      properties:
        service:
          type: string
          description: Name of the service being checked
          example: "database"
        status:
          type: string
          enum: [ok, error, warning]
          description: Service health status
        response_time_ms:
          type: integer
          format: int32
          description: Response time in milliseconds
          example: 12
          nullable: true
        details:
          type: object
          description: Service-specific details
          additionalProperties: true
        error:
          type: string
          description: Error message if status is 'error'
          nullable: true

    DetailedHealthResponse:
      type: object
      required:
        - status
        - environment
        - timestamp
      properties:
        status:
          type: string
          enum: [ok, error, degraded]
          description: Overall health status
        environment:
          type: string
          enum: [development, test, production]
        version:
          type: string
          description: Application version
        commit:
          type: string
          description: Git commit SHA
          pattern: "^[a-f0-9]{40}$"
        deployed_at:
          type: string
          format: date-time
          description: Last deployment timestamp
        uptime_seconds:
          type: integer
          format: int64
          description: Application uptime in seconds
        timestamp:
          type: string
          format: date-time
          description: Health check timestamp
        services:
          type: object
          description: Detailed status of all services
          additionalProperties:
            $ref: '#/components/schemas/ServiceHealthResponse'
        metrics:
          type: object
          description: Application and system metrics
          properties:
            php_version:
              type: string
              example: "8.3.2"
            php_memory_usage_mb:
              type: integer
              description: Current PHP memory usage in MB
            php_memory_peak_mb:
              type: integer
              description: Peak PHP memory usage in MB
            opcache_enabled:
              type: boolean
            opcache_hit_rate:
              type: number
              format: float
              description: OPcache hit rate percentage
              minimum: 0
              maximum: 100

security: []

externalDocs:
  description: CI/CD Pipeline Documentation
  url: https://docs.myshop.com/cicd
