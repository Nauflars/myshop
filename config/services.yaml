parameters:
    # Stock management configuration (spec-008 US2)
    app.stock.low_threshold: 10  # Products with stock below this are considered low stock
    
    # Context storage TTL configuration (spec-009)
    app.context.customer_ttl: '%env(int:CUSTOMER_CONTEXT_TTL)%'
    app.context.admin_ttl: '%env(int:ADMIN_CONTEXT_TTL)%'

services:
    _defaults:
        autowire: true
        autoconfigure: true
        bind:
            $defaultLowStockThreshold: '%app.stock.low_threshold%'

    App\:
        resource: '../src/'
        exclude:
            - '../src/Domain/Entity/'
            - '../src/Domain/ValueObject/'
            - '../src/Kernel.php'

    # Domain Repository Interfaces -> Infrastructure Implementations
    App\Domain\Repository\UserRepositoryInterface:
        class: App\Infrastructure\Repository\DoctrineUserRepository

    App\Domain\Repository\ProductRepositoryInterface:
        class: App\Infrastructure\Repository\DoctrineProductRepository

    App\Domain\Repository\CartRepositoryInterface:
        class: App\Infrastructure\Repository\DoctrineCartRepository

    App\Domain\Repository\OrderRepositoryInterface:
        class: App\Infrastructure\Repository\DoctrineOrderRepository

    App\Domain\Repository\ConversationRepositoryInterface:
        class: App\Infrastructure\Repository\DoctrineConversationRepository

    # Controllers
    App\Infrastructure\Controller\:
        resource: '../src/Infrastructure/Controller/'
        tags: ['controller.service_arguments']

    # Bind specific AI agents to controllers to prevent inlining
    App\Infrastructure\Controller\ChatbotController:
        arguments:
            $agent: '@ai.agent.openAiAgent'
            $unifiedContextManager: '@App\Application\Service\UnifiedCustomerContextManager'

    App\Infrastructure\Controller\AdminAssistantController:
        arguments:
            $adminAgent: '@ai.agent.adminAssistant'

    # Use Cases
    App\Application\UseCase\:
        resource: '../src/Application/UseCase/'

    # AI Infrastructure Services
    App\Infrastructure\AI\Service\:
        resource: '../src/Infrastructure/AI/Service/'
    
    # AI Tools - Tagged for automatic discovery by AIBundle
    App\Infrastructure\AI\Tool\:
        resource: '../src/Infrastructure/AI/Tool/'
        autowire: true
        autoconfigure: true
        tags: ['ai.tool']
        public: true

    # AI Agents (spec-003 will add Conversation persistence)
    # App\Infrastructure\AI\Agent\:
    #     resource: '../src/Infrastructure/AI/Agent/'

    # Chatbot Services (commented out - stub implementation only)
    # App\Infrastructure\Chatbot\:
    #     resource: '../src/Infrastructure/Chatbot/'

    # Context Storage Infrastructure (spec-009)
    App\Domain\Repository\ContextStorageInterface:
        class: App\Infrastructure\Repository\RedisContextStorage
        public: true
        arguments:
            $redis: '@Predis\Client'

    # Unified Conversation Storage (spec-012)
    App\Infrastructure\Repository\UnifiedConversationStorage:
        public: true
        arguments:
            $redis: '@Predis\Client'
            $logger: '@logger'
            $defaultTtl: '%env(int:CONTEXT_TTL)%'

    # Unified Context Managers (spec-012)
    App\Application\Service\UnifiedCustomerContextManager:
        public: true
        arguments:
            $storage: '@App\Infrastructure\Repository\UnifiedConversationStorage'
            $logger: '@logger'
            $ttl: '%app.context.customer_ttl%'

    App\Application\Service\UnifiedAdminContextManager:
        public: true
        arguments:
            $storage: '@App\Infrastructure\Repository\UnifiedConversationStorage'
            $logger: '@logger'
            $ttl: '%app.context.admin_ttl%'

    # Legacy Context Management Services (spec-009) - DEPRECATED
    # Will be removed after migration to spec-012 unified architecture
    App\Application\Service\CustomerContextManager:
        public: true
        arguments:
            $ttl: '%app.context.customer_ttl%'

    App\Application\Service\AdminContextManager:
        public: true
        arguments:
            $ttl: '%app.context.admin_ttl%'

    # AI Services - prevent inlining for dependency injection
    App\Infrastructure\AI\Service\RoleAwareAssistant:
        public: true

    App\Infrastructure\AI\Service\ConversationManager:
        public: true

    App\Infrastructure\AI\Service\AdminConversationManager:
        public: true

    App\Application\Service\UnansweredQuestionCapture:
        public: true

    # MongoDB Client (spec-010)
    # T081: Connection pooling configured via URI parameters
    # URI format: mongodb://host:port/database?maxPoolSize=50&minPoolSize=10&maxIdleTimeMS=60000
    MongoDB\Client:
        public: true
        arguments:
            $uri: '%env(MONGODB_URL)%'
            $uriOptions: []
            $driverOptions: []

    # OpenAI Embedding Service (spec-010)
    # Uses Symfony AI Platform (MANDATORY per spec-010 section 4.1)
    App\Infrastructure\AI\Service\OpenAIEmbeddingService:
        public: true
        arguments:
            $platform: '@ai.platform.openai'
            $logger: '@logger'
            $model: '%env(OPENAI_EMBEDDING_MODEL)%'

    # MongoDB Embedding Repository (spec-010)
    App\Infrastructure\Repository\MongoDBEmbeddingRepository:
        public: true
        arguments:
            $mongoClient: '@MongoDB\Client'
            $logger: '@logger'
            $databaseName: '%env(MONGO_DATABASE)%'

    # Embedding Service Interface binding (spec-010)
    App\Domain\Repository\EmbeddingServiceInterface: '@App\Infrastructure\AI\Service\OpenAIEmbeddingService'

    # Vector Index Commands (spec-010)
    App\Command\CreateVectorIndexCommand:
        public: true
        arguments:
            $repository: '@App\Infrastructure\Repository\MongoDBEmbeddingRepository'
            $mongoClient: '@MongoDB\Client'
            $logger: '@logger'
            $databaseName: '%env(MONGO_DATABASE)%'
        tags: ['console.command']

    App\Command\TestEmbeddingCommand:
        public: true
        arguments:
            $embeddingService: '@App\Domain\Repository\EmbeddingServiceInterface'
            $repository: '@App\Infrastructure\Repository\MongoDBEmbeddingRepository'
        tags: ['console.command']

    # Product Embedding Sync Services (spec-010 Phase 1)
    App\Application\Service\ProductEmbeddingSyncService:
        public: true

    App\Application\UseCase\SyncProductEmbedding:
        public: true

    App\Infrastructure\Persistence\Listener\ProductEmbeddingListener:
        public: true
        tags:
            - { name: 'doctrine.event_listener', event: 'postPersist' }
            - { name: 'doctrine.event_listener', event: 'postUpdate' }
            - { name: 'doctrine.event_listener', event: 'postRemove' }

    # Sync Commands (spec-010 Phase 1)
    App\Command\SyncAllEmbeddingsCommand:
        public: true
        tags: ['console.command']

    App\Command\BatchSyncEmbeddingsCommand:
        public: true
        tags: ['console.command']

    # Embedding Cache Service (spec-010 Phase 3)
    App\Application\Service\EmbeddingCacheService:
        public: true
        arguments:
            $cache: '@cache.app'
            $logger: '@logger'
            $embeddingCacheTtl: '%env(EMBEDDING_CACHE_TTL)%'

    # Semantic Search Services (spec-010 Phase 2)
    App\Application\Service\SemanticSearchService:
        public: true

    App\Application\Service\KeywordSearchService:
        public: true

    App\Application\Service\SearchFacade:
        public: true

    # Error Message Translator (spec-010 Phase 6 T094)
    App\Application\Service\ErrorMessageTranslator:
        public: true
        arguments:
            $logger: '@logger'

    # Failed Job Registry (spec-010 Phase 6 T095)
    App\Application\Service\FailedJobRegistry:
        public: true
        arguments:
            $connection: '@doctrine.dbal.default_connection'
            $logger: '@logger'

    # Failure Rate Monitor (spec-010 Phase 6 T096)
    App\Application\Service\FailureRateMonitor:
        public: true
        arguments:
            $cache: '@cache.app'
            $logger: '@logger'

    # Cache Management Commands (spec-010 Phase 3)
    App\Command\ClearEmbeddingCacheCommand:
        public: true
        tags: ['console.command']

    # Performance Monitoring Services (spec-010 Phase 5)
    App\Application\Service\SearchMetricsCollector:
        public: true
        arguments:
            $cache: '@cache.app'
            $logger: '@logger'

    # Admin Metrics Controller (spec-010 Phase 5 T089)
    App\Infrastructure\Controller\AdminMetricsController:
        public: true

    # Symfony Stopwatch for profiling (spec-010 Phase 5 T074)
    Symfony\Component\Stopwatch\Stopwatch:
        public: true
