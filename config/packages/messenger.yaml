framework:
  messenger:
    # Enviar mensajes fallidos a un failure transport (DLQ)
    failure_transport: failed

    # ====== TRANSPORTS (RabbitMQ) ======
    transports:
      # 1) Actualizaciones de embeddings de usuario
      user_embedding_updates:
        dsn: '%env(RABBITMQ_DSN)%'
        serializer: 'messenger.transport.symfony_serializer'
        options:
          auto_setup: true
          exchange:
            name: 'user_embedding_updates'
            type: direct
            # CLAVE: si usas direct + binding_keys, publica con routing key por defecto
            default_publish_routing_key: 'user.embedding.update'
          queues:
            user_embedding_updates:
              binding_keys: [ 'user.embedding.update' ]
        retry_strategy:
          max_retries: 5
          delay: 5000
          multiplier: 2
          max_delay: 30000

      # 2) Sincronización de embeddings
      embedding_sync:
        dsn: '%env(RABBITMQ_DSN)%'
        serializer: 'messenger.transport.symfony_serializer'
        options:
          auto_setup: true
          exchange:
            name: 'embedding_sync'
            type: direct
            default_publish_routing_key: 'embedding.sync'
          queues:
            embedding_sync:
              binding_keys: [ 'embedding.sync' ]
        retry_strategy:
          max_retries: 3
          delay: 3000
          multiplier: 2
          max_delay: 30000

      # 3) Failure transport (DLQ) en RabbitMQ
      failed:
        dsn: '%env(RABBITMQ_DSN)%'
        serializer: 'messenger.transport.symfony_serializer'
        options:
          auto_setup: true
          exchange:
            name: 'failed'
            type: direct
            default_publish_routing_key: 'failed'
          queues:
            failed:
              binding_keys: [ 'failed' ]

    # ====== ROUTING ======
    # Cualquier mensaje que matchee aquí se manda a RabbitMQ (asíncrono)
    routing:
      'App\Application\Message\UpdateUserEmbeddingMessage': user_embedding_updates
      'App\Application\Message\SyncEmbeddingMessage': embedding_sync

    # ====== BUS ======
    default_bus: messenger.bus.default

    buses:
      messenger.bus.default:
        # Mantén el default middleware ENABLED para que existan send_message/handle_message
        # y además fuerza error si un mensaje no tiene sender o handler (como querías).
        default_middleware:
          enabled: true
          allow_no_senders: false
          allow_no_handlers: false

        # Middleware extra (se ejecutan dentro del bus)
        middleware:
          - validation
          - doctrine_transaction
