# Symfony Messenger Configuration for User Embeddings Queue

framework:
    messenger:
        # Failure transport (Dead Letter Queue)
        failure_transport: failed

        # Transport definitions  
        transports:
            # Doctrine (MySQL) transport for user embedding updates
            user_embedding_updates:
                dsn: 'doctrine://default?queue_name=user_embedding_updates'
                serializer: 'messenger.transport.symfony_serializer'

            # Failed messages transport (DLQ - uses Doctrine/MySQL)
            failed:
                dsn: 'doctrine://default?queue_name=failed'
                serializer: 'messenger.transport.symfony_serializer'

        # Message routing - Send UpdateUserEmbeddingMessage to RabbitMQ transport
        routing:
            'App\Application\Message\UpdateUserEmbeddingMessage':
                senders: ['user_embedding_updates']

        # Single bus for both sending and receiving
        default_bus: messenger.bus.default

        buses:
            messenger.bus.default:
                # Explicitly order middleware: send_message FIRST, then handle
                default_middleware:
                    enabled: false  # Disable default order
                middleware:
                    - send_message  # FORCE sending to transport BEFORE handling
                    - validation
                    - doctrine_transaction
                    - handle_message  # Handle locally only if not sent to transport
