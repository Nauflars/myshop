// Main Jenkinsfile for master branch deployments
// This pipeline handles automated deployment to test and production environments

pipeline {
    agent {
        docker {
            image 'myshop-jenkins:latest'
            args '-v /var/run/docker.sock:/var/run/docker.sock -v $PWD:/workspace'
        }
    }
    
    environment {
        COMPOSER_HOME = "${WORKSPACE}/.composer"
        COMPOSER_ALLOW_SUPERUSER = "1"
        ANSIBLE_VAULT_PASSWORD_FILE = credentials('ansible-vault-password')
    }
    
    options {
        timeout(time: 60, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '50', artifactNumToKeepStr: '10'))
        disableConcurrentBuilds()
    }
    
    stages {
        stage('Build') {
            options {
                timeout(time: 15, unit: 'MINUTES')
            }
            steps {
                echo '→ Installing dependencies...'
                sh 'composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist'
                
                echo '→ Building assets...'
                sh 'bash scripts/ci/build-assets.sh || true'
                
                echo '→ Creating vendor archive...'
                sh 'bash scripts/ci/archive-vendor.sh'
            }
        }
        
        stage('Test') {
            options {
                timeout(time: 15, unit: 'MINUTES')
            }
            steps {
                echo '→ Running test suite...'
                sh 'bash scripts/ci/run-tests.sh all'
            }
        }
        
        stage('Deploy to Test') {
            options {
                timeout(time: 10, unit: 'MINUTES')
            }
            steps {
                script {
                    // Run pre-deployment checks
                    echo '→ Running pre-deployment checks...'
                    sh 'bash scripts/deploy/pre-deploy.sh test'
                    
                    // Deploy using Ansible
                    echo '→ Deploying to test environment...'
                    sh '''
                        ansible-playbook deployment/deploy-local.yml \
                            -i deployment/inventories/local-test/hosts \
                            -e "branch=${GIT_COMMIT}" \
                            -e "container_name=myshop-test" \
                            --vault-password-file=${ANSIBLE_VAULT_PASSWORD_FILE}
                    '''
                    
                    // Run post-deployment tasks
                    echo '→ Running post-deployment tasks...'
                    sh 'bash scripts/deploy/post-deploy.sh test'
                }
            }
        }
        
        stage('Health Check - Test') {
            options {
                timeout(time: 5, unit: 'MINUTES')
            }
            steps {
                echo '→ Verifying test environment health...'
                sh 'bash scripts/deploy/smoke-test.sh test'
            }
        }
        
        stage('E2E Tests on Test') {
            options {
                timeout(time: 20, unit: 'MINUTES')
            }
            when {
                branch 'master'
            }
            steps {
                script {
                    echo '→ Running E2E tests on test environment...'
                    dir('tests/E2E') {
                        sh 'npm ci --silent'
                        sh 'npx playwright install --with-deps chromium'
                        
                        def testResult = sh(
                            script: 'BASE_URL=http://localhost:8081 npm test -- --workers=4 --retries=2',
                            returnStatus: true
                        )
                        
                        publishHTML([
                            allowMissing: false,
                            alwaysLinkToLastBuild: true,
                            keepAll: true,
                            reportDir: 'playwright-report',
                            reportFiles: 'index.html',
                            reportName: 'Playwright Report - Test',
                        ])
                        
                        if (testResult != 0) {
                            error('E2E tests failed on test environment')
                        }
                    }
                }
            }
        }
        
        stage('Approve Production Deployment') {
            when {
                branch 'master'
            }
            options {
                timeout(time: 24, unit: 'HOURS')
            }
            steps {
                script {
                    echo '→ Waiting for production deployment approval...'
                    
                    def userInput = input(
                        id: 'ProductionApproval',
                        message: 'Deploy to Production?',
                        parameters: [
                            booleanParam(
                                defaultValue: false,
                                description: 'Confirm deployment to production environment',
                                name: 'APPROVE'
                            )
                        ],
                        submitter: 'devops-team,admin',
                        submitterParameter: 'APPROVED_BY'
                    )
                    
                    env.APPROVED_BY = userInput.APPROVED_BY
                    
                    if (!userInput.APPROVE) {
                        error('Production deployment was not approved')
                    }
                    
                    echo "✓ Production deployment approved by: ${env.APPROVED_BY}"
                }
            }
        }
        
        stage('Deploy to Production') {
            when {
                branch 'master'
            }
            options {
                timeout(time: 15, unit: 'MINUTES')
            }
            steps {
                script {
                    // Check pending migrations
                    echo '→ Checking for pending migrations...'
                    sh 'bash scripts/ci/check-migrations.sh || true'
                    
                    // Run pre-deployment checks
                    echo '→ Running pre-deployment checks...'
                    sh 'bash scripts/deploy/pre-deploy.sh production'
                    
                    // Deploy using Ansible
                    echo '→ Deploying to production environment...'
                    sh '''
                        ansible-playbook deployment/deploy-local.yml \
                            -i deployment/inventories/local-production/hosts \
                            -e "branch=${GIT_COMMIT}" \
                            -e "container_name=myshop-prod" \
                            --vault-password-file=${ANSIBLE_VAULT_PASSWORD_FILE}
                    '''
                    
                    // Run post-deployment tasks
                    echo '→ Running post-deployment tasks...'
                    sh 'bash scripts/deploy/post-deploy.sh production'
                }
            }
        }
        
        stage('Smoke Tests - Production') {
            when {
                branch 'master'
            }
            options {
                timeout(time: 10, unit: 'MINUTES')
            }
            steps {
                echo '→ Running comprehensive smoke tests on production...'
                sh 'bash scripts/deploy/smoke-test.sh production'
                
                script {
                    // Verify all critical health endpoints
                    def healthChecks = [
                        'database': 'http://localhost:8082/api/health/database',
                        'redis': 'http://localhost:8082/api/health/redis',
                        'mongodb': 'http://localhost:8082/api/health/mongodb',
                        'rabbitmq': 'http://localhost:8082/api/health/rabbitmq'
                    ]
                    
                    healthChecks.each { name, url ->
                        echo "Checking ${name}..."
                        sh "curl -sf ${url} || exit 1"
                    }
                }
                
                echo '✓ All smoke tests passed on production'
            }
        }
        
        stage('Tag Release') {
            when {
                branch 'master'
            }
            steps {
                script {
                    def timestamp = sh(script: "date +%Y%m%d%H%M%S", returnStdout: true).trim()
                    def tagName = "prod-v${BUILD_NUMBER}-${timestamp}"
                    
                    echo "→ Creating Git tag: ${tagName}"
                    sh """
                        git tag -a ${tagName} -m "Production deployment by ${env.APPROVED_BY}" || true
                        git push origin ${tagName} || true
                    """
                    
                    env.RELEASE_TAG = tagName
                }
            }
        }
    }
    
    post {
        always {
            junit allowEmptyResults: true, testResults: 'var/log/phpunit/*.xml'
            
            archiveArtifacts artifacts: 'artifacts/*.tar.gz', allowEmptyArchive: true
            
            script {
                // Log deployment to file
                sh '''
                    echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC") - Build ${BUILD_NUMBER} - Commit ${GIT_COMMIT}" >> var/log/deployments.log
                '''
            }
        }
        
        success {
            script {
                if (env.BRANCH_NAME == 'master' && env.RELEASE_TAG) {
                    echo '✓ Production deployment completed successfully!'
                    sh """
                        bash .jenkins/scripts/notify-slack.sh "success" "$BUILD_URL" \
                        "Production deployment successful - Tag: ${env.RELEASE_TAG} - Deployed by: ${env.APPROVED_BY}"
                    """
                } else {
                    echo '✓ Test deployment completed successfully!'
                    sh 'bash .jenkins/scripts/notify-slack.sh "success" "$BUILD_URL" "Deployed to test environment"'
                }
            }
        }
        
        failure {
            script {
                if (env.STAGE_NAME?.contains('Production')) {
                    echo '✗ Production deployment failed!'
                    sh """
                        bash .jenkins/scripts/notify-slack.sh "failed" "$BUILD_URL" \
                        "Production deployment failed - ROLLBACK REQUIRED"
                    """
                } else {
                    echo '✗ Test deployment failed!'
                    sh 'bash .jenkins/scripts/notify-slack.sh "failed" "$BUILD_URL" "Test deployment failed"'
                }
            }
        }
        
        aborted {
            echo '⚠ Pipeline was aborted'
            sh 'bash .jenkins/scripts/notify-slack.sh "warning" "$BUILD_URL" "Pipeline aborted by user"'
        }
    }
}
